<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel de Prospecção – Rafa</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f7;
      margin: 0;
      padding: 20px;
    }
    h1 { margin-top: 0; }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #ffffff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.06);
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    label {
      font-size: 12px;
      font-weight: 600;
      color: #444;
      display: block;
      margin-bottom: 4px;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 13px;
      box-sizing: border-box;
    }
    textarea { min-height: 60px; resize: vertical; }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 8px 0 16px;
      align-items: center;
    }
    button {
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
    }
    button.primary { background: #111827; color: #fff; }
    button.secondary { background: #e5e7eb; color: #111827; }
    button.danger { background: #fee2e2; color: #b91c1c; }

    /* Botões de ação na tabela */
    td.acoes { white-space: nowrap; }
    .acao-group {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .acao-btn {
      padding: 3px 6px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      font-size: 10px;
      font-weight: 600;
      cursor: pointer;
    }
    .acao-btn:hover { background: #e5e7eb; }
    .acao-btn.primary { background: #111827; color: #fff; border-color: #111827; }
    .acao-btn.danger { background: #fee2e2; color: #b91c1c; border-color: #fecaca; }

    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th, td {
      padding: 6px 4px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
    }
    th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #6b7280;
      white-space: nowrap;
    }
    tr:hover { background: #f9fafb; }

    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      display: inline-block;
    }
    .badge.novo { background: #e0f2fe; color: #0369a1; }
    .badge.conversa { background: #fef3c7; color: #92400e; }
    .badge.agendado { background: #dcfce7; color: #166534; }
    .badge.fechado { background: #bbf7d0; color: #166534; }
    .badge.perdido { background: #fee2e2; color: #b91c1c; }

    .kpi-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
      font-size: 12px;
      color: #374151;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0 14px;
      font-size: 12px;
      align-items: flex-end;
    }
    .filters > div {
      min-width: 140px;
    }
    .filters label {
      margin-bottom: 2px;
    }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
    }

    @media (max-width: 900px) {
      body { padding: 10px; }
      .container {
        padding: 14px;
        border-radius: 8px;
        box-shadow: none;
      }
      .form-grid { grid-template-columns: 1fr; }
      th, td { font-size: 11px; }
      .acao-btn { font-size: 9px; padding: 3px 4px; }
      .filters > div { min-width: 48%; }
    }
  </style>
</head>

<body>
  <div class="container">

    <h1>Painel de Prospecção – Pacote Temporada</h1>
    <p style="font-size:12px;color:#6b7280;">
      Registre aqui os estabelecimentos que você abordar. Os dados ficam salvos no navegador (localStorage).
    </p>

    <h2>+ Novo Lead / Atualizar Lead</h2>

    <!-- FORMULÁRIO -->
    <div class="form-grid">
      <div><label>Estabelecimento</label><input id="estabelecimento" type="text"/></div>
      <div><label>Responsável</label><input id="responsavel" type="text"/></div>
      <div><label>Telefone</label><input id="telefone" type="text"/></div>

      <div><label>Data da visita</label><input id="dataVisita" type="date"/></div>

      <div>
        <label>Origem</label>
        <select id="origem">
          <option value="Presencial">Presencial</option>
          <option value="Instagram">Instagram</option>
          <option value="WhatsApp">WhatsApp</option>
          <option value="Telefone">Telefone</option>
          <option value="Indicação">Indicação</option>
        </select>
      </div>

      <div>
        <label>Categoria</label>
        <select id="categoria">
          <option value="">Selecione</option>
          <option value="Restaurante">Restaurante</option>
          <option value="Café / Padaria">Café / Padaria</option>
          <option value="Sorveteria / Açaí">Sorveteria / Açaí</option>
          <option value="Bar / Pub">Bar / Pub</option>
          <option value="Loja de Roupas / Surf">Loja de Roupas / Surf</option>
          <option value="Petshop">Petshop</option>
          <option value="Clínica Estética / Beleza">Clínica Estética / Beleza</option>
          <option value="Academia / Studio">Academia / Studio</option>
          <option value="Mercado / Empório">Mercado / Empório</option>
          <option value="Outro comércio">Outro comércio</option>
        </select>
      </div>

      <div>
        <label>Produto</label>
        <select id="produto">
          <option value="">Não definido</option>
          <option value="Pacote Vídeos Temporada">Pacote Vídeos Temporada</option>
          <option value="Tratamento Imagens iFood">Tratamento Imagens iFood</option>
          <option value="Ambos">Ambos</option>
        </select>
      </div>

      <div>
        <label>Potencial</label>
        <select id="potencial">
          <option value="">?</option>
          <option value="1">1 – Baixo</option>
          <option value="2">2 – Médio</option>
          <option value="3">3 – Alto</option>
        </select>
      </div>

      <div>
        <label>Interesse</label>
        <select id="interesse">
          <option value="">Selecione</option>
          <option value="Sim">Sim</option>
          <option value="Talvez">Talvez</option>
          <option value="Não">Não</option>
        </select>
      </div>

      <div>
        <label>Status</label>
        <select id="status">
          <option value="Novo">Novo</option>
          <option value="Em conversa">Em conversa</option>
          <option value="Agendado">Agendado</option>
          <option value="Fechado">Fechado</option>
          <option value="Perdido">Perdido</option>
        </select>
      </div>

      <div>
        <label>Urgência</label>
        <select id="urgencia">
          <option value="">Não avaliada</option>
          <option value="Alta">Alta</option>
          <option value="Média">Média</option>
          <option value="Baixa">Baixa</option>
        </select>
      </div>

      <div>
        <label>Decisor presente?</label>
        <select id="decisor">
          <option value="">Não marcado</option>
          <option value="Sim">Sim</option>
          <option value="Não">Não</option>
        </select>
      </div>

      <div>
        <label>Valor (R$)</label>
        <input id="valorJob" type="number" placeholder="600"/>
      </div>

      <div>
        <label>Data decisão</label>
        <input id="dataDecisao" type="date"/>
      </div>

      <div>
        <label>Motivo perda (se tiver)</label>
        <select id="motivoPerda">
          <option value="">Nenhum</option>
          <option value="Preço">Preço</option>
          <option value="Sem caixa">Sem caixa</option>
          <option value="Não vê valor">Não vê valor</option>
          <option value="Já tem fornecedor">Já tem fornecedor</option>
          <option value="Sem tempo">Sem tempo</option>
        </select>
      </div>

    </div>

    <label>Próximo passo</label>
    <textarea id="proximoPasso"></textarea>

    <div class="actions">
      <button class="primary" onclick="salvarLead()">Salvar lead</button>
      <button class="secondary" onclick="limparFormulario()">Limpar</button>
      <button class="danger" onclick="apagarTudo()">Apagar tudo</button>

      <button onclick="exportarLeads()">Exportar</button>
      <button onclick="importarLeads()">Importar</button>

      <span id="modoEdicao" style="color:#6b7280;"></span>
    </div>

    <!-- KPIs -->
    <div class="kpi-row">
      <span><strong>Leads (filtrados):</strong> <span id="totalLeads">0</span></span>
      <span><strong>Fechados:</strong> <span id="kpiFechados">0</span></span>
      <span><strong>Agendados:</strong> <span id="kpiAgendados">0</span></span>
      <span><strong>Perdidos:</strong> <span id="kpiPerdidos">0</span></span>
      <span><strong>Estimado:</strong> R$ <span id="kpiValorTotal">0</span></span>
    </div>

    <!-- FILTROS -->
    <div class="filters">
      <div>
        <label>Status</label>
        <select id="filtroStatus" onchange="renderTabela()">
          <option value="Todos">Todos</option>
          <option value="Novo">Novo</option>
          <option value="Em conversa">Em conversa</option>
          <option value="Agendado">Agendado</option>
          <option value="Fechado">Fechado</option>
          <option value="Perdido">Perdido</option>
        </select>
      </div>
      <div>
        <label>Urgência</label>
        <select id="filtroUrgencia" onchange="renderTabela()">
          <option value="Todas">Todas</option>
          <option value="Alta">Alta</option>
          <option value="Média">Média</option>
          <option value="Baixa">Baixa</option>
        </select>
      </div>
      <div>
        <label>Produto</label>
        <select id="filtroProduto" onchange="renderTabela()">
          <option value="Todos">Todos</option>
          <option value="Pacote Vídeos Temporada">Pacote Vídeos Temporada</option>
          <option value="Tratamento Imagens iFood">Tratamento Imagens iFood</option>
          <option value="Ambos">Ambos</option>
          <option value="Não definido">Não definido</option>
        </select>
      </div>
      <div>
        <label>Categoria</label>
        <select id="filtroCategoria" onchange="renderTabela()">
          <option value="Todas">Todas</option>
          <option value="Restaurante">Restaurante</option>
          <option value="Café / Padaria">Café / Padaria</option>
          <option value="Sorveteria / Açaí">Sorveteria / Açaí</option>
          <option value="Bar / Pub">Bar / Pub</option>
          <option value="Loja de Roupas / Surf">Loja de Roupas / Surf</option>
          <option value="Petshop">Petshop</option>
          <option value="Clínica Estética / Beleza">Clínica Estética / Beleza</option>
          <option value="Academia / Studio">Academia / Studio</option>
          <option value="Mercado / Empório">Mercado / Empório</option>
          <option value="Outro comércio">Outro comércio</option>
        </select>
      </div>
      <div>
        <label>Interesse</label>
        <select id="filtroInteresse" onchange="renderTabela()">
          <option value="Todos">Todos</option>
          <option value="Sim">Sim</option>
          <option value="Talvez">Talvez</option>
          <option value="Não">Não</option>
        </select>
      </div>
      <div>
        <label>Prazo decisão</label>
        <select id="filtroPrazo" onchange="renderTabela()">
          <option value="Todos">Todos</option>
          <option value="Vencidas">Decisão vencida</option>
          <option value="Futuras">Decisão futura</option>
        </select>
      </div>
      <div>
        <button class="secondary" onclick="limparFiltros()">Limpar filtros</button>
      </div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Estabelecimento</th>
            <th>Cat.</th>
            <th>Produto</th>
            <th>Resp.</th>
            <th>Tel</th>
            <th>Origem</th>
            <th>Data</th>
            <th>Pot.</th>
            <th>Int.</th>
            <th>Status</th>
            <th>Urg.</th>
            <th>Decisor</th>
            <th>R$</th>
            <th>Decisão</th>
            <th>Perda</th>
            <th>Próx passo</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="tabelaLeads"></tbody>
      </table>
    </div>

  </div>

<script>
let leads = [];
let indiceEdicao = null;

// atalho
const el = id => document.getElementById(id);

function chaveLead(l){
  return (l.estab || "").toLowerCase().trim() + "|" +
         (l.tel || "").replace(/\D/g,"");
}

function carregarLeads(){
  const salvo = localStorage.getItem("painelProspecaoRafa_v3");
  if(salvo){ leads = JSON.parse(salvo); }
  renderTabela();
}
function salvarLocal(){ localStorage.setItem("painelProspecaoRafa_v3", JSON.stringify(leads)); }

function salvarLead(){
  const estab = el("estabelecimento").value.trim();
  if(!estab){
    alert("Coloque o nome do estabelecimento");
    return;
  }

  const l = {
    estab,
    resp: el("responsavel").value.trim(),
    tel: el("telefone").value.trim(),
    data: el("dataVisita").value || new Date().toISOString().slice(0,10),
    origem: el("origem").value,
    categoria: el("categoria").value,
    produto: el("produto").value || "Não definido",
    potencial: el("potencial").value || "2",
    interesse: el("interesse").value,
    status: el("status").value,
    urgencia: el("urgencia").value,
    decisor: el("decisor").value,
    valorJob: el("valorJob").value || "600",
    dataDecisao: el("dataDecisao").value || new Date(Date.now()+3*86400000).toISOString().slice(0,10),
    motivoPerda: el("motivoPerda").value,
    proximoPasso: el("proximoPasso").value.trim() || "Fazer follow-up"
  };

  if(indiceEdicao !== null){
    leads[indiceEdicao] = l;
    indiceEdicao = null;
    el("modoEdicao").textContent = "";
  } else {
    leads.push(l);
  }

  salvarLocal();
  limparFormulario(false);
  renderTabela();
}

function limparFormulario(reset=true){
  document.querySelectorAll("input, textarea").forEach(elm=>elm.value="");
  document.querySelectorAll("select").forEach(elm=>elm.value="");

  el("status").value = "Novo";
  el("origem").value = "Presencial";

  if(reset){
    indiceEdicao = null;
    el("modoEdicao").textContent="";
  }
}

function badge(c){
  switch(c){
    case "Novo": return "badge novo";
    case "Em conversa": return "badge conversa";
    case "Agendado": return "badge agendado";
    case "Fechado": return "badge fechado";
    case "Perdido": return "badge perdido";
    default: return "badge";
  }
}

function aplicarFiltros(lista){
  const fStatus    = el("filtroStatus").value;
  const fUrg       = el("filtroUrgencia").value;
  const fProd      = el("filtroProduto").value;
  const fCat       = el("filtroCategoria").value;
  const fInt       = el("filtroInteresse").value;
  const fPrazo     = el("filtroPrazo").value;
  const hoje       = new Date().toISOString().slice(0,10);

  return lista.filter(l => {
    if(fStatus !== "Todos" && l.status !== fStatus) return false;
    if(fUrg !== "Todas" && l.urgencia !== fUrg) return false;
    if(fProd !== "Todos" && (l.produto || "Não definido") !== fProd) return false;
    if(fCat !== "Todas" && l.categoria !== fCat) return false;
    if(fInt !== "Todos" && l.interesse !== fInt) return false;

    if(fPrazo !== "Todos"){
      const d = l.dataDecisao || "";
      if(!d) return false;
      if(fPrazo === "Vencidas" && !(d < hoje)) return false;
      if(fPrazo === "Futuras" && !(d >= hoje)) return false;
    }

    return true;
  });
}

function renderTabela(){
  const tbody = el("tabelaLeads");
  tbody.innerHTML="";

  const filtrados = aplicarFiltros(leads);

  let total=0, fech=0, per=0, ag=0, estimado=0;

  filtrados.forEach((l,iGlobal)=>{
    total++;
    if(l.status==="Fechado") fech++;
    if(l.status==="Perdido") per++;
    if(l.status==="Agendado") ag++;
    estimado += parseFloat(l.valorJob||0);

    const indexReal = leads.indexOf(l); // mantém link para array original

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${l.estab}</td>
      <td>${l.categoria||""}</td>
      <td>${l.produto||""}</td>
      <td>${l.resp||""}</td>
      <td>${l.tel||""}</td>
      <td>${l.origem||""}</td>
      <td>${l.data||""}</td>
      <td>${l.potencial||""}</td>
      <td>${l.interesse||""}</td>
      <td><span class="${badge(l.status)}">${l.status||""}</span></td>
      <td>${l.urgencia||""}</td>
      <td>${l.decisor||""}</td>
      <td>${l.valorJob||""}</td>
      <td>${l.dataDecisao||""}</td>
      <td>${l.motivoPerda||""}</td>
      <td>${(l.proximoPasso||"").replace(/\n/g,"<br>")}</td>
      <td class="acoes">
        <div class="acao-group">
          <button class="acao-btn primary" onclick="editarLead(${indexReal})">Editar</button>
          <button class="acao-btn" onclick="marcarFechado(${indexReal})">Fechou 600</button>
          <button class="acao-btn" onclick="agendarFollowUp(${indexReal})">Follow-up +3d</button>
          <button class="acao-btn" onclick="marcarPerdido(${indexReal})">Perdido</button>
          <button class="acao-btn danger" onclick="removerLead(${indexReal})">X</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  el("totalLeads").textContent=total;
  el("kpiFechados").textContent=fech;
  el("kpiPerdidos").textContent=per;
  el("kpiAgendados").textContent=ag;
  el("kpiValorTotal").textContent=estimado.toFixed(0);
}

function limparFiltros(){
  el("filtroStatus").value    = "Todos";
  el("filtroUrgencia").value  = "Todas";
  el("filtroProduto").value   = "Todos";
  el("filtroCategoria").value = "Todas";
  el("filtroInteresse").value = "Todos";
  el("filtroPrazo").value     = "Todos";
  renderTabela();
}

function editarLead(i){
  const l = leads[i];
  el("estabelecimento").value = l.estab || "";
  el("responsavel").value = l.resp || "";
  el("telefone").value = l.tel || "";
  el("dataVisita").value = l.data || "";
  el("origem").value = l.origem || "Presencial";
  el("categoria").value = l.categoria || "";
  el("produto").value = l.produto && l.produto !== "Não definido" ? l.produto : "";
  el("potencial").value = l.potencial || "";
  el("interesse").value = l.interesse || "";
  el("status").value = l.status || "Novo";
  el("urgencia").value = l.urgencia || "";
  el("decisor").value = l.decisor || "";
  el("valorJob").value = l.valorJob || "";
  el("dataDecisao").value = l.dataDecisao || "";
  el("motivoPerda").value = l.motivoPerda || "";
  el("proximoPasso").value = l.proximoPasso || "";
  indiceEdicao = i;
  el("modoEdicao").textContent = "Editando: " + (l.estab || "");
}

function removerLead(i){
  if(!confirm("Remover lead?")) return;
  leads.splice(i,1);
  salvarLocal();
  renderTabela();
}

function marcarFechado(i){
  leads[i].status="Fechado";
  if(!leads[i].valorJob || leads[i].valorJob==="0") leads[i].valorJob="600";
  salvarLocal(); renderTabela();
}

function marcarPerdido(i){
  leads[i].status="Perdido";
  if(!leads[i].motivoPerda) leads[i].motivoPerda="Sem caixa";
  salvarLocal(); renderTabela();
}

function agendarFollowUp(i){
  const d = new Date();
  d.setDate(d.getDate()+3);
  leads[i].dataDecisao = d.toISOString().slice(0,10);
  if(!leads[i].proximoPasso) leads[i].proximoPasso="Fazer follow-up";
  salvarLocal(); renderTabela();
}

function exportarLeads(){
  if(!leads.length){
    alert("Não há leads para exportar.");
    return;
  }
  const txt = JSON.stringify(leads, null, 2);
  navigator.clipboard.writeText(txt).then(()=>{
    alert("Copiado! Cole no outro dispositivo para importar.");
  }).catch(()=>{
    prompt("Copie os dados:", txt);
  });
}

function importarLeads(){
  const texto = prompt("Cole aqui os dados exportados:");
  if(!texto) return;

  try{
    const arr = JSON.parse(texto);
    if(!Array.isArray(arr)){
      alert("Formato inválido!");
      return;
    }

    const mapa = new Map();
    leads.forEach((l,i)=> mapa.set(chaveLead(l), i));

    let adicionados=0, atualizados=0;

    arr.forEach(l=>{
      const c = chaveLead(l);
      if(mapa.has(c)){
        leads[ mapa.get(c) ] = l; // sobrescreve
        atualizados++;
      } else {
        leads.push(l);
        adicionados++;
      }
    });

    salvarLocal();
    renderTabela();

    alert(`Importado.\nNovos: ${adicionados}\nAtualizados: ${atualizados}`);
  } catch(e){
    alert("JSON inválido.");
  }
}

carregarLeads();
</script>

</body>
</html>
